services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      # Inside docker network the Prism mock is reachable via service name.
      - NEXT_PUBLIC_API_URL=http://prism:4010
      - NEXT_TELEMETRY_DISABLED=1
      - NODE_ENV=development
      # macOS/Windows Docker Desktop ではファイル監視が不安定なことがあるため（必要に応じて無効化可）
      - WATCHPACK_POLLING=true
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - next_cache:/app/.next
      - pnpm_store:/pnpm/store
    depends_on:
      - prism
    command: >
      sh -lc "pnpm install --frozen-lockfile --force && mkdir -p .next && (find .next -mindepth 1 -delete || true) && pnpm dev"

  prism:
    image: stoplight/prism:4
    command: ["mock", "-h", "0.0.0.0", "-p", "4010", "/tmp/openapi.yaml"]
    ports:
      - "4111:4010"
    volumes:
      - ./openapi.yaml:/tmp/openapi.yaml:ro

volumes:
  node_modules:
  next_cache:
  pnpm_store:


