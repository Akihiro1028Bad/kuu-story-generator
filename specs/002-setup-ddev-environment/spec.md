# Feature Specification: ddev環境構築とNext.js・モックサーバーセットアップ

**Feature Branch**: `002-setup-ddev-environment`  
**Created**: 2025-12-08  
**Status**: Draft  
**Input**: User description: "ddev環境を構築して欲しいです。next.jsのセットアップ、モックサーバーのセットアップまでお願いしたい"

## Clarifications

### Session 2025-12-08

- Q: モックサーバーのOpenAPI仕様書の管理方法 → A: プロジェクトルートに `openapi.yaml` を配置し、バージョン管理下に置く
- Q: Next.jsアプリケーションからモックサーバーへの接続方法 → A: 環境変数でモックサーバーのURLを設定し、Next.jsから参照する
- Q: 環境変数の管理方法 → A: `.env.local` ファイルをプロジェクトルートに配置し、`.gitignore` で除外する（テンプレートファイル `.env.example` はバージョン管理下に置く）
- Q: モックサーバーの起動タイミング → A: ddev環境起動時に自動的に起動する
- Q: Next.js開発サーバーの起動方法 → A: 開発者が手動で `ddev exec pnpm dev` を実行して起動する

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ddev環境の初期セットアップ (Priority: P1)

開発者がプロジェクトの開発環境を一から構築できるようにする。

**Why this priority**: 開発環境が整備されていないと、以降の開発作業を開始できないため、最優先で実装する必要がある。

**Independent Test**: `ddev start` コマンドを実行し、すべてのコンテナが正常に起動することを確認できる。これにより、開発環境の基盤が整備されたことを検証できる。

**Acceptance Scenarios**:

1. **Given** プロジェクトのルートディレクトリにいる, **When** `ddev start` コマンドを実行する, **Then** ddev環境が正常に起動し、必要なコンテナが稼働していることを確認できる
2. **Given** ddev環境が起動している, **When** `ddev describe` コマンドを実行する, **Then** 設定されたサービス（Next.js用コンテナ、モックサーバー用コンテナ）の情報が表示される
3. **Given** ddev環境が起動している, **When** `ddev ssh` コマンドでコンテナに接続する, **Then** コンテナ内でコマンドを実行できることを確認できる

---

### User Story 2 - Next.jsアプリケーションのセットアップ (Priority: P2)

開発者がNext.jsアプリケーションを開発・実行できる環境を整備する。

**Why this priority**: アプリケーションの開発を開始するためには、Next.jsのセットアップが完了している必要がある。ddev環境の構築の次に重要。

**Independent Test**: `ddev exec pnpm dev` コマンドを実行し、Next.js開発サーバーが起動し、ブラウザでアクセスできることを確認できる。これにより、Next.jsアプリケーションが正常に動作することを検証できる。

**Acceptance Scenarios**:

1. **Given** ddev環境が起動している, **When** `ddev exec pnpm install` を実行する, **Then** 必要なパッケージがインストールされる
2. **Given** パッケージがインストールされている, **When** `ddev exec pnpm dev` を実行する, **Then** Next.js開発サーバーが起動し、指定されたポートでアクセス可能になる
3. **Given** Next.js開発サーバーが起動している, **When** ブラウザでアクセスする, **Then** アプリケーションの初期画面が表示される
4. **Given** ソースコードを変更する, **When** ファイルを保存する, **Then** ホットリロードが機能し、変更が即座に反映される

---

### User Story 3 - モックサーバーのセットアップ (Priority: P2)

開発者が外部APIに依存せずに開発を進められるよう、Prismモックサーバーをセットアップする。

**Why this priority**: 開発中は外部API（Nano Banana Pro API）に依存せずに開発を進める必要があるため、モックサーバーのセットアップは重要。Next.jsのセットアップと同等の優先度。

**Independent Test**: `ddev start` コマンドを実行し、モックサーバーが自動的に起動し、APIエンドポイントにアクセスできることを確認できる。これにより、モックサーバーが正常に動作することを検証できる。

**Acceptance Scenarios**:

1. **Given** ddev環境が起動している, **When** モックサーバー用コンテナの状態を確認する, **Then** Prismモックサーバーが正常に稼働していることを確認できる
2. **Given** モックサーバーが稼働している, **When** Next.jsアプリケーションからモックサーバーのエンドポイントにリクエストを送信する, **Then** モックレスポンスが返される
3. **Given** モックサーバーが稼働している, **When** OpenAPI仕様書を更新する, **Then** モックサーバーが新しい仕様に基づいてレスポンスを返す
4. **Given** ddev環境を停止する, **When** `ddev stop` コマンドを実行する, **Then** モックサーバーを含むすべてのコンテナが正常に停止する

---

### Edge Cases

- ddevが既にインストールされていない場合、インストール手順が明確に文書化されているか？
- ポートが既に使用されている場合、適切なエラーメッセージが表示されるか？
- コンテナの起動に失敗した場合、ログが適切に出力され、問題の原因を特定できるか？
- ネットワーク接続がない環境でも、ローカル開発環境として機能するか？
- 複数の開発者が同じ環境を構築する際、一貫性が保たれるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ddevコマンド一つで開発環境全体を起動できるようにしなければならない
- **FR-002**: システムは、Next.jsアプリケーション用のコンテナを提供し、開発者が `ddev exec pnpm dev` コマンドで開発サーバーを手動起動できるようにしなければならない
- **FR-003**: システムは、Prismモックサーバー用のコンテナを提供し、ddev環境起動時に自動的に起動し、開発中にAPIのモックレスポンスを返せるようにしなければならない
- **FR-004**: システムは、パッケージマネージャー（pnpm）を使用して依存関係を管理できるようにしなければならない
- **FR-005**: システムは、開発環境の設定をバージョン管理下に置き、再現可能な環境を提供しなければならない
- **FR-006**: システムは、Next.jsアプリケーションとモックサーバーが適切に連携できるように、ネットワーク設定を提供しなければならない
- **FR-010**: システムは、モックサーバーのURLを環境変数で設定し、Next.jsアプリケーションから参照できるようにしなければならない
- **FR-011**: システムは、環境変数を `.env.local` ファイルで管理し、`.gitignore` で除外しなければならない。また、テンプレートファイル `.env.example` をバージョン管理下に置き、新規開発者が必要な環境変数を把握できるようにしなければならない
- **FR-007**: システムは、開発環境の起動・停止・再起動を簡単に実行できるようにしなければならない
- **FR-008**: システムは、開発環境の状態（稼働中のコンテナ、ポート、ログなど）を確認できるようにしなければならない
- **FR-009**: システムは、OpenAPI仕様書をプロジェクトルートの `openapi.yaml` として管理し、バージョン管理下に置かなければならない

### Key Entities *(include if feature involves data)*

- **開発環境設定**: ddevの設定ファイル（.ddev/config.yaml）で定義される、コンテナ構成、ポート、環境変数などの情報
- **モックサーバー設定**: Prismモックサーバーの設定（OpenAPI仕様書のパス（プロジェクトルートの `openapi.yaml`）、ポート、レスポンスモードなど）
- **環境変数設定**: Next.jsアプリケーションがモックサーバーに接続するためのURLを環境変数で管理する設定（`.env.local` ファイルで管理し、`.env.example` をテンプレートとして提供）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者は、`ddev start` コマンド1回の実行で、5分以内に開発環境を起動できる
- **SC-002**: 開発環境が起動した後、Next.jsアプリケーションにブラウザからアクセスし、3秒以内に初期画面が表示される
- **SC-003**: モックサーバーは、Next.jsアプリケーションからのAPIリクエストに対して、1秒以内にモックレスポンスを返す
- **SC-004**: 新規開発者が環境構築手順に従って作業した場合、初回セットアップを30分以内に完了できる
- **SC-005**: 開発環境の起動成功率は95%以上である（環境の違いによる失敗を除く）
- **SC-006**: 開発環境の停止・再起動は、それぞれ1分以内に完了する

## Assumptions

- ddevが開発者のマシンにインストールされている、またはインストール手順が提供される
- Docker Desktop（または同等のDocker環境）が利用可能である
- 開発者のマシンに十分なリソース（メモリ、CPU、ディスク容量）が確保されている
- プロジェクトのルートディレクトリに適切な権限がある
- インターネット接続が利用可能である（初回セットアップ時のパッケージダウンロード用）

## Dependencies

- ddevのインストールと設定
- Docker環境の利用可能性
- プロジェクトのconstitutionに定義された技術スタック（Next.js、Node.js、TypeScript、pnpm）の要件

## Out of Scope

- 本番環境のセットアップ
- CI/CDパイプラインの構築
- データベースのセットアップ（初期段階では不要のため）
- 本番用のモックサーバー（開発環境専用）
