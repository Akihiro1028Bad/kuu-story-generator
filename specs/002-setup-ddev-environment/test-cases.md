# Test Cases: ddev環境構築とNext.js・モックサーバーセットアップ

**Date**: 2025-12-08  
**Feature**: 002-setup-ddev-environment  
**Purpose**: 開発環境の動作確認と検証

## テスト種別の説明

- **Unit Test (UT)**: 個別の設定ファイルやスクリプトの検証
- **Integration Test (IT)**: 複数コンポーネント間の連携確認

## 単体テスト (Unit Tests)

### UT-001: ddev設定ファイルの検証

| 項目 | 内容 |
|------|------|
| **テストID** | UT-001 |
| **テスト名** | ddev設定ファイル（.ddev/config.yaml）の形式検証 |
| **テスト種別** | Unit |
| **テスト観点・目的** | ddev設定ファイルが正しい形式で記述されていることを確認 |
| **前提条件** | `.ddev/config.yaml`が存在する |
| **実行手順** | 1. `.ddev/config.yaml`を読み込む<br>2. YAML形式が正しいことを確認<br>3. 必須フィールド（name, type, webserver_type）が存在することを確認<br>4. nodejs_versionが`22.20.0`であることを確認<br>5. corepack_enableが`true`であることを確認 |
| **テストデータ** | `.ddev/config.yaml`ファイル |
| **期待結果** | - YAML形式が正しい<br>- 必須フィールドがすべて存在する<br>- バージョンが正しい<br>- エラーが発生しない |
| **対象ファイル/関数** | `.ddev/config.yaml` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 1 |
| **優先度** | P1 |

### UT-002: Prism Docker Compose設定の検証

| 項目 | 内容 |
|------|------|
| **テストID** | UT-002 |
| **テスト名** | Prism Docker Compose設定ファイルの形式検証 |
| **テスト種別** | Unit |
| **テスト観点・目的** | Prismコンテナ設定が正しい形式で記述されていることを確認 |
| **前提条件** | `.ddev/docker-compose.prism.yaml`が存在する |
| **実行手順** | 1. `.ddev/docker-compose.prism.yaml`を読み込む<br>2. YAML形式が正しいことを確認<br>3. services.prismが存在することを確認<br>4. imageが`stoplight/prism:4`であることを確認<br>5. commandに`-p 4010`が含まれることを確認<br>6. volumesに`./openapi.yaml:/tmp/openapi.yaml:ro`が含まれることを確認 |
| **テストデータ** | `.ddev/docker-compose.prism.yaml`ファイル |
| **期待結果** | - YAML形式が正しい<br>- 必須フィールドがすべて存在する<br>- イメージとコマンドが正しい<br>- エラーが発生しない |
| **対象ファイル/関数** | `.ddev/docker-compose.prism.yaml` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 3 |
| **優先度** | P1 |

### UT-003: OpenAPI仕様書の検証

| 項目 | 内容 |
|------|------|
| **テストID** | UT-003 |
| **テスト名** | OpenAPI仕様書（openapi.yaml）の形式検証 |
| **テスト種別** | Unit |
| **テスト観点・目的** | OpenAPI仕様書が正しい形式で記述されていることを確認 |
| **前提条件** | `openapi.yaml`が存在する |
| **実行手順** | 1. `openapi.yaml`を読み込む<br>2. YAML形式が正しいことを確認<br>3. `openapi`フィールドが`3.0.2`であることを確認<br>4. `info`セクションが存在することを確認<br>5. `paths`セクションが存在することを確認 |
| **テストデータ** | `openapi.yaml`ファイル |
| **期待結果** | - YAML形式が正しい<br>- OpenAPI 3.0.2形式である<br>- 必須セクションがすべて存在する<br>- Prismが読み込める形式である |
| **対象ファイル/関数** | `openapi.yaml` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 3 |
| **優先度** | P1 |

### UT-004: 環境変数テンプレートの検証

| 項目 | 内容 |
|------|------|
| **テストID** | UT-004 |
| **テスト名** | 環境変数テンプレート（.env.example）の検証 |
| **テスト種別** | Unit |
| **テスト観点・目的** | 環境変数テンプレートが正しい形式で記述されていることを確認 |
| **前提条件** | `.env.example`が存在する |
| **実行手順** | 1. `.env.example`を読み込む<br>2. `NEXT_PUBLIC_API_URL`が定義されていることを確認<br>3. コメントが適切に記述されていることを確認<br>4. 機密情報が含まれていないことを確認 |
| **テストデータ** | `.env.example`ファイル |
| **期待結果** | - 必須環境変数が定義されている<br>- コメントが適切<br>- 機密情報が含まれていない |
| **対象ファイル/関数** | `.env.example` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 2 |
| **優先度** | P2 |

### UT-005: .gitignoreの検証

| 項目 | 内容 |
|------|------|
| **テストID** | UT-005 |
| **テスト名** | .gitignoreに.env.localが含まれていることを確認 |
| **テスト種別** | Unit |
| **テスト観点・目的** | 機密情報が誤ってコミットされないことを確認 |
| **前提条件** | `.gitignore`が存在する |
| **実行手順** | 1. `.gitignore`を読み込む<br>2. `.env.local`が含まれていることを確認<br>3. `.env*.local`が含まれていることを確認 |
| **テストデータ** | `.gitignore`ファイル |
| **期待結果** | - `.env.local`が`.gitignore`に含まれている<br>- `.env*.local`が`.gitignore`に含まれている |
| **対象ファイル/関数** | `.gitignore` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 2 |
| **優先度** | P1 |

### 単体テストセクション全体の予想カバレッジ率

- **行カバレッジ**: 100%
- **分岐カバレッジ**: 100%

## 統合テスト (Integration Tests)

### IT-001: ddev環境の起動確認

| 項目 | 内容 |
|------|------|
| **テストID** | IT-001 |
| **テスト名** | ddev環境が正常に起動することを確認 |
| **テスト種別** | Integration |
| **テスト観点・目的** | ddev startコマンドで環境全体が正常に起動することを確認 |
| **前提条件** | - ddevがインストールされている<br>- Dockerが起動している<br>- `.ddev/config.yaml`が存在する<br>- `.ddev/docker-compose.prism.yaml`が存在する |
| **実行手順** | 1. プロジェクトルートで`ddev start`を実行<br>2. コマンドが正常に完了することを確認<br>3. `ddev describe`でサービス状態を確認<br>4. webコンテナが起動していることを確認<br>5. prismコンテナが起動していることを確認 |
| **テストデータ** | なし |
| **期待結果** | - `ddev start`が正常に完了する（5分以内）<br>- webコンテナが`running`状態である<br>- prismコンテナが`running`状態である<br>- エラーメッセージが表示されない |
| **対象ファイル/関数** | `.ddev/config.yaml`, `.ddev/docker-compose.prism.yaml` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 1 |
| **優先度** | P1 |

### IT-002: Next.js開発サーバーの起動確認

| 項目 | 内容 |
|------|------|
| **テストID** | IT-002 |
| **テスト名** | Next.js開発サーバーが正常に起動することを確認 |
| **テスト種別** | Integration |
| **テスト観点・目的** | Next.js開発サーバーが起動し、ブラウザでアクセスできることを確認 |
| **前提条件** | - ddev環境が起動している<br>- Next.jsプロジェクトが初期化されている<br>- パッケージがインストールされている |
| **実行手順** | 1. `ddev exec pnpm dev`を実行<br>2. サーバーが起動することを確認（ログで確認）<br>3. ブラウザで`https://kuu-story-generator.ddev.site:8080`にアクセス<br>4. Next.jsの初期画面が表示されることを確認（3秒以内） |
| **テストデータ** | なし |
| **期待結果** | - Next.js開発サーバーが起動する<br>- ブラウザでアクセスできる<br>- 初期画面が3秒以内に表示される<br>- エラーメッセージが表示されない |
| **対象ファイル/関数** | `package.json`, `app/page.tsx` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 2 |
| **優先度** | P1 |

### IT-003: Prismモックサーバーの動作確認

| 項目 | 内容 |
|------|------|
| **テストID** | IT-003 |
| **テスト名** | Prismモックサーバーが正常に動作することを確認 |
| **テスト種別** | Integration |
| **テスト観点・目的** | Prismモックサーバーが起動し、OpenAPI仕様書に基づいたレスポンスを返すことを確認 |
| **前提条件** | - ddev環境が起動している<br>- `openapi.yaml`が存在する<br>- prismコンテナが起動している |
| **実行手順** | 1. `ddev exec curl http://prism:4010/api/v1/generate`を実行<br>2. レスポンスが返されることを確認（1秒以内）<br>3. レスポンスのステータスコードが200であることを確認<br>4. レスポンスボディがOpenAPI仕様書に基づいていることを確認 |
| **テストデータ** | `openapi.yaml`に定義されたエンドポイント |
| **期待結果** | - リクエストが成功する（1秒以内）<br>- ステータスコードが200である<br>- レスポンスボディがOpenAPI仕様書に基づいている<br>- エラーメッセージが表示されない |
| **対象ファイル/関数** | `.ddev/docker-compose.prism.yaml`, `openapi.yaml` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 3 |
| **優先度** | P1 |

### IT-004: ネットワーク接続の確認

| 項目 | 内容 |
|------|------|
| **テストID** | IT-004 |
| **テスト名** | Next.jsアプリケーションからPrismモックサーバーへの接続確認 |
| **テスト種別** | Integration |
| **テスト観点・目的** | Next.jsアプリケーションが環境変数で設定したURLでPrismモックサーバーに接続できることを確認 |
| **前提条件** | - ddev環境が起動している<br>- Next.js開発サーバーが起動している<br>- Prismモックサーバーが起動している<br>- `.env.local`が存在し、`NEXT_PUBLIC_API_URL`が設定されている |
| **実行手順** | 1. Next.jsアプリケーションからAPIリクエストを送信<br>2. 環境変数`NEXT_PUBLIC_API_URL`が正しく読み込まれていることを確認<br>3. Prismモックサーバーにリクエストが到達することを確認<br>4. モックレスポンスが返されることを確認 |
| **テストデータ** | APIリクエスト（Next.jsアプリケーションから） |
| **期待結果** | - 環境変数が正しく読み込まれる<br>- Prismモックサーバーに接続できる<br> - モックレスポンスが返される（1秒以内）<br>- エラーメッセージが表示されない |
| **対象ファイル/関数** | `.env.local`, `lib/api/client.ts`（実装時） |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 2, User Story 3 |
| **優先度** | P1 |

### IT-005: ホットリロードの確認

| 項目 | 内容 |
|------|------|
| **テストID** | IT-005 |
| **テスト名** | Next.js開発サーバーのホットリロード機能の確認 |
| **テスト種別** | Integration |
| **テスト観点・目的** | ソースコードを変更した際に、自動的に変更が反映されることを確認 |
| **前提条件** | - ddev環境が起動している<br>- Next.js開発サーバーが起動している<br>- ブラウザでアプリケーションにアクセスしている |
| **実行手順** | 1. `app/page.tsx`を編集（テキストを変更）<br>2. ファイルを保存<br>3. ブラウザで変更が即座に反映されることを確認 |
| **テストデータ** | `app/page.tsx`の編集内容 |
| **期待結果** | - ファイル保存後、即座に変更が反映される<br>- ページのリロードが不要である<br>- エラーメッセージが表示されない |
| **対象ファイル/関数** | `app/page.tsx` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 2 |
| **優先度** | P2 |

### IT-006: 環境停止の確認

| 項目 | 内容 |
|------|------|
| **テストID** | IT-006 |
| **テスト名** | ddev環境が正常に停止することを確認 |
| **テスト種別** | Integration |
| **テスト観点・目的** | ddev stopコマンドで環境全体が正常に停止することを確認 |
| **前提条件** | - ddev環境が起動している<br>- すべてのコンテナが稼働している |
| **実行手順** | 1. `ddev stop`を実行<br>2. コマンドが正常に完了することを確認（1分以内）<br>3. すべてのコンテナが停止していることを確認<br>4. `ddev describe`でサービス状態を確認 |
| **テストデータ** | なし |
| **期待結果** | - `ddev stop`が正常に完了する（1分以内）<br>- すべてのコンテナが停止している<br>- エラーメッセージが表示されない |
| **対象ファイル/関数** | `.ddev/config.yaml`, `.ddev/docker-compose.prism.yaml` |
| **予想カバレッジ率** | 行カバレッジ: 100%, 分岐カバレッジ: 100% |
| **関連ユーザーストーリー** | User Story 1, User Story 3 |
| **優先度** | P2 |

### 統合テストセクション全体の予想カバレッジ率

- **行カバレッジ**: 100%
- **分岐カバレッジ**: 100%

## テスト実行手順

### 前提条件の確認

1. ddevがインストールされていること
2. Dockerが起動していること
3. プロジェクトルートに必要なファイルが存在すること

### テスト実行順序

1. **単体テスト**: UT-001 ～ UT-005を順次実行
2. **統合テスト**: IT-001 → IT-002 → IT-003 → IT-004 → IT-005 → IT-006の順で実行

### テスト結果の記録

各テストケースの実行結果を記録し、失敗した場合は原因を調査する。

## 注意事項

- テスト実行前にddev環境をクリーンな状態にする（`ddev stop` → `ddev start`）
- ポート競合が発生した場合は、設定を確認する
- ネットワーク接続が必要なテストは、インターネット接続を確認する

