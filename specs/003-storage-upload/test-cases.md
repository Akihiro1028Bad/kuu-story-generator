# Test Cases: ストレージベースのアップロード・URLベースのアーキテクチャ

**Date**: 2025-01-27  
**Feature**: 003-storage-upload

## 単体テスト（Unit Tests）

### UploadSection.tsx

| テストID | テスト名 | テスト種別 | テスト観点・目的 | 前提条件 | 実行手順 | テストデータ | 期待結果 | 対象ファイル/関数 | 予想カバレッジ率 | 関連ユーザーストーリー | 優先度 |
|---------|---------|-----------|----------------|---------|---------|------------|---------|------------------|----------------|---------------------|--------|
| UT-001 | ファイル選択時にVercel Blobにアップロードできる（正常系） | Unit | ファイル選択時に`upload()`が呼び出され、アップロードが成功することを確認 | - `@vercel/blob/client`がインストールされている<br>- `/api/upload`エンドポイントが実装されている<br>- 有効な画像ファイル（JPEG/PNG、10MB以下）が選択される | 1. `UploadSection`コンポーネントをレンダリング<br>2. ファイル入力で有効な画像ファイルを選択<br>3. `upload()`が呼び出されることを確認<br>4. アップロード完了後、`blob.url`が取得されることを確認 | ファイル: `test-image.jpg` (2MB, `image/jpeg`) | - `upload()`が1回呼び出される<br>- `blob.url`が文字列として取得される<br>- `onImageSelected`が`blob.url`で呼び出される<br>- エラーが発生しない | `app/components/KuuGenerator/UploadSection.tsx`<br>`handleFileChange()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 1 | P1 |
| UT-002 | 無効なファイル形式でエラーを表示する（異常系） | Unit | JPEG/PNG以外のファイル形式でエラーメッセージが表示されることを確認 | - `UploadSection`コンポーネントがレンダリングされている | 1. ファイル入力で無効なファイル形式（例: `.txt`）を選択<br>2. エラーメッセージが表示されることを確認 | ファイル: `test.txt` (1KB, `text/plain`) | - `upload()`が呼び出されない<br>- エラーメッセージ「JPEGまたはPNG形式の画像を選択してください。」が表示される<br>- `onImageSelected`が`null`で呼び出される | `app/components/KuuGenerator/UploadSection.tsx`<br>`handleFileChange()` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 3 | P1 |
| UT-003 | 10MBを超えるファイルでエラーを表示する（境界値） | Unit | 10MBを超えるファイルでエラーメッセージが表示されることを確認 | - `UploadSection`コンポーネントがレンダリングされている | 1. ファイル入力で10MBを超える画像ファイル（例: 11MB）を選択<br>2. エラーメッセージが表示されることを確認 | ファイル: `large-image.jpg` (11MB, `image/jpeg`) | - `upload()`が呼び出されない<br>- エラーメッセージ「画像サイズは10MB以下にしてください。」が表示される<br>- `onImageSelected`が`null`で呼び出される | `app/components/KuuGenerator/UploadSection.tsx`<br>`handleFileChange()` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 3 | P1 |
| UT-004 | アップロード進行状況を表示する（正常系） | Unit | `onUploadProgress`コールバックで進行状況が更新されることを確認 | - `UploadSection`コンポーネントがレンダリングされている<br>- 有効な画像ファイルが選択される | 1. ファイル入力で有効な画像ファイルを選択<br>2. `onUploadProgress`が呼び出されることを確認<br>3. `uploadProgress`ステートが更新されることを確認<br>4. 進行状況バーが表示されることを確認 | ファイル: `test-image.jpg` (5MB, `image/jpeg`) | - `onUploadProgress`が複数回呼び出される<br>- `uploadProgress`が0から100まで増加する<br>- 進行状況バーが表示される | `app/components/KuuGenerator/UploadSection.tsx`<br>`handleFileChange()`, `onUploadProgress` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 1 | P2 |
| UT-005 | アップロード中断時にBlobRequestAbortedErrorを処理する（異常系） | Unit | `abortSignal`を使用してアップロードを中断し、エラーを適切に処理することを確認 | - `UploadSection`コンポーネントがレンダリングされている<br>- アップロードが進行中 | 1. ファイル入力で有効な画像ファイルを選択<br>2. アップロード中に`abortController.abort()`を呼び出す<br>3. `BlobRequestAbortedError`が発生することを確認<br>4. エラーメッセージが表示されることを確認 | ファイル: `test-image.jpg` (5MB, `image/jpeg`) | - `BlobRequestAbortedError`が発生する<br>- エラーメッセージ「アップロードがキャンセルされました。」が表示される<br>- `onImageSelected`が`null`で呼び出される<br>- プレビューがクリアされる | `app/components/KuuGenerator/UploadSection.tsx`<br>`handleFileChange()`, `abortController` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 3 | P2 |
| UT-006 | アップロード失敗時にエラーメッセージを表示する（異常系） | Unit | アップロード失敗時に適切なエラーメッセージが表示されることを確認 | - `UploadSection`コンポーネントがレンダリングされている<br>- `/api/upload`エンドポイントがエラーを返す | 1. ファイル入力で有効な画像ファイルを選択<br>2. `/api/upload`がエラーを返すようにモック<br>3. エラーメッセージが表示されることを確認 | ファイル: `test-image.jpg` (2MB, `image/jpeg`) | - `upload()`がエラーをスローする<br>- エラーメッセージ「アップロードに失敗しました。再試行してください。」が表示される<br>- `onImageSelected`が`null`で呼び出される | `app/components/KuuGenerator/UploadSection.tsx`<br>`handleFileChange()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 3 | P1 |

### actions.ts

| テストID | テスト名 | テスト種別 | テスト観点・目的 | 前提条件 | 実行手順 | テストデータ | 期待結果 | 対象ファイル/関数 | 予想カバレッジ率 | 関連ユーザーストーリー | 優先度 |
|---------|---------|-----------|----------------|---------|---------|------------|---------|------------------|----------------|---------------------|--------|
| UT-007 | FormDataからimageUrlを取得できる（正常系） | Unit | `formData.get('imageUrl')`で画像URLを文字列として取得できることを確認 | - `generateKuu` Server Actionが実装されている<br>- FormDataに`imageUrl`が含まれている | 1. FormDataを作成し、`imageUrl`を追加<br>2. `generateKuu`を呼び出す<br>3. `formData.get('imageUrl')`でURLが取得されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', textPhraseId: 'phrase1', styleIds: 'style1', positionId: 'pos1', outputFormat: 'jpeg' }` | - `formData.get('imageUrl')`が文字列として取得される<br>- URL形式が有効であることを確認<br>- エラーが発生しない | `app/components/KuuGenerator/actions.ts`<br>`generateKuu()` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 1 | P1 |
| UT-008 | 無効なURL形式でエラーを返す（異常系） | Unit | 無効なURL形式でエラーメッセージが返されることを確認 | - `generateKuu` Server Actionが実装されている<br>- FormDataに無効な`imageUrl`が含まれている | 1. FormDataを作成し、無効な`imageUrl`を追加<br>2. `generateKuu`を呼び出す<br>3. エラーメッセージが返されることを確認 | FormData: `{ imageUrl: 'invalid-url', textPhraseId: 'phrase1', styleIds: 'style1', positionId: 'pos1', outputFormat: 'jpeg' }` | - `isValidUrl()`が`false`を返す<br>- エラーメッセージ「必須項目が不足しています。画像とすべての選択肢を選んでください。」が返される<br>- `status: 'error'`が返される | `app/components/KuuGenerator/actions.ts`<br>`generateKuu()`, `isValidUrl()` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 3 | P1 |
| UT-009 | BFF APIにimageUrlを送信できる（正常系） | Unit | BFF APIにFormDataで`imageUrl`を送信できることを確認 | - `generateKuu` Server Actionが実装されている<br>- BFF APIが実装されている<br>- `KUU_USE_REAL_API=1`が設定されている | 1. FormDataを作成し、`imageUrl`を追加<br>2. `generateKuu`を呼び出す<br>3. BFF APIに`imageUrl`が送信されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', textPhraseId: 'phrase1', styleIds: 'style1', positionId: 'pos1', outputFormat: 'jpeg' }` | - `formDataForAPI.append('imageUrl', imageUrl)`が実行される<br>- BFF APIにFormDataが送信される<br>- エラーが発生しない | `app/components/KuuGenerator/actions.ts`<br>`generateKuu()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 1 | P1 |
| UT-010 | モックモードでimageUrlから画像を取得できる（正常系） | Unit | モックモードで`imageUrl`から画像を取得してdata URLに変換できることを確認 | - `generateKuu` Server Actionが実装されている<br>- `KUU_USE_REAL_API`が設定されていない | 1. FormDataを作成し、`imageUrl`を追加<br>2. `generateKuu`を呼び出す<br>3. `imageUrl`から画像を取得してdata URLに変換されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', textPhraseId: 'phrase1', styleIds: 'style1', positionId: 'pos1', outputFormat: 'jpeg' }` | - `fetch(imageUrl)`が呼び出される<br>- 画像が取得される<br>- data URLに変換される<br>- `status: 'success'`が返される | `app/components/KuuGenerator/actions.ts`<br>`generateKuu()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 1 | P2 |
| UT-028 | 互換期間中にimageUrlとimageDataUrlの両方を扱える（正常系） | Unit | BFF APIが`imageUrl`と`imageDataUrl`の両方を返す場合、`imageUrl`を優先して扱えることを確認 | - `generateKuu` Server Actionが実装されている<br>- BFF APIレスポンスに`imageUrl`と`imageDataUrl`が含まれる | 1. BFF APIレスポンスをモック（`imageUrl`と`imageDataUrl`の両方）<br>2. `generateKuu`を呼び出す<br>3. `imageUrl`を優先して状態に反映されることを確認 | レスポンス: `{ imageUrl: 'https://.../generated.jpg', imageDataUrl: 'data:image/png;base64,...', mimeType: 'image/png', width: 1024, height: 1024 }` | - `imageUrl`が優先される<br>- 互換的に動作する | `app/components/KuuGenerator/actions.ts`<br>`generateKuu()` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 2 | P2 |

### /api/upload/route.ts

| テストID | テスト名 | テスト種別 | テスト観点・目的 | 前提条件 | 実行手順 | テストデータ | 期待結果 | 対象ファイル/関数 | 予想カバレッジ率 | 関連ユーザーストーリー | 優先度 |
|---------|---------|-----------|----------------|---------|---------|------------|---------|------------------|----------------|---------------------|--------|
| UT-011 | handleUpload()でトークンを生成できる（正常系） | Unit | `handleUpload()`が呼び出され、トークンが生成されることを確認 | - `/api/upload`エンドポイントが実装されている<br>- `@vercel/blob/client`がインストールされている | 1. POSTリクエストを`/api/upload`に送信<br>2. `handleUpload()`が呼び出されることを確認<br>3. トークンが生成されることを確認 | リクエストボディ: `{ pathname: 'test.jpg', clientPayload: {} }` | - `handleUpload()`が呼び出される<br>- `onBeforeGenerateToken`が呼び出される<br>- トークンが生成される<br>- 200ステータスが返される | `app/api/upload/route.ts`<br>`POST()` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 1 | P1 |
| UT-012 | onBeforeGenerateTokenでバリデーションを実施する（正常系） | Unit | `onBeforeGenerateToken`でファイル形式のバリデーションが実施されることを確認 | - `/api/upload`エンドポイントが実装されている | 1. POSTリクエストを`/api/upload`に送信<br>2. `onBeforeGenerateToken`が呼び出されることを確認<br>3. バリデーションが実施されることを確認 | リクエストボディ: `{ pathname: 'test.jpg', clientPayload: {} }` | - `onBeforeGenerateToken`が呼び出される<br>- ファイル形式のバリデーションが実施される<br>- `allowedContentTypes`が返される | `app/api/upload/route.ts`<br>`POST()`, `onBeforeGenerateToken` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 1 | P1 |
| UT-013 | 無効なファイル形式でエラーを返す（異常系） | Unit | 無効なファイル形式でエラーメッセージが返されることを確認 | - `/api/upload`エンドポイントが実装されている | 1. POSTリクエストを`/api/upload`に送信（無効なファイル形式）<br>2. エラーメッセージが返されることを確認 | リクエストボディ: `{ pathname: 'test.txt', clientPayload: {} }` | - `onBeforeGenerateToken`でエラーがスローされる<br>- エラーメッセージ「無効なファイル形式です。JPEGまたはPNG形式のみアップロードできます。」が返される<br>- 400ステータスが返される | `app/api/upload/route.ts`<br>`POST()`, `onBeforeGenerateToken` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 3 | P1 |
| UT-014 | onUploadCompletedでログを記録する（正常系） | Unit | アップロード完了時に`onUploadCompleted`が呼び出され、ログが記録されることを確認 | - `/api/upload`エンドポイントが実装されている<br>- アップロードが完了している | 1. アップロード完了のwebhookを受信<br>2. `onUploadCompleted`が呼び出されることを確認<br>3. ログが記録されることを確認 | Webhook: `{ type: 'blob.upload-completed', blob: { url: 'https://...', pathname: 'test.jpg' } }` | - `onUploadCompleted`が呼び出される<br>- ログが記録される<br>- 200ステータスが返される | `app/api/upload/route.ts`<br>`POST()`, `onUploadCompleted` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 1 | P2 |

### /api/generate/route.ts

| テストID | テスト名 | テスト種別 | テスト観点・目的 | 前提条件 | 実行手順 | テストデータ | 期待結果 | 対象ファイル/関数 | 予想カバレッジ率 | 関連ユーザーストーリー | 優先度 |
|---------|---------|-----------|----------------|---------|---------|------------|---------|------------------|----------------|---------------------|--------|
| UT-015 | FormDataからimageUrlを取得できる（正常系） | Unit | `formData.get('imageUrl')`で画像URLを文字列として取得できることを確認 | - `/api/generate`エンドポイントが実装されている<br>- FormDataに`imageUrl`が含まれている | 1. POSTリクエストを`/api/generate`に送信（FormDataに`imageUrl`を含む）<br>2. `formData.get('imageUrl')`でURLが取得されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', textPhraseId: 'phrase1', styleIds: 'style1', positionId: 'pos1', outputFormat: 'jpeg' }` | - `formData.get('imageUrl')`が文字列として取得される<br>- URL形式が有効であることを確認<br>- エラーが発生しない | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 1 | P1 |
| UT-016 | 画像URLから画像をダウンロードしてbase64に変換できる（正常系） | Unit | `fetch(imageUrl)`で画像を取得し、base64に変換できることを確認 | - `/api/generate`エンドポイントが実装されている<br>- 有効な画像URLが提供される | 1. POSTリクエストを`/api/generate`に送信<br>2. `fetch(imageUrl)`が呼び出されることを確認<br>3. 画像がbase64に変換されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', ... }` | - `fetch(imageUrl)`が呼び出される<br>- 画像が取得される<br>- `Buffer.from().toString('base64')`でbase64に変換される<br>- エラーが発生しない | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 1 | P1 |
| UT-017 | 画像URL取得失敗時にエラーを返す（異常系） | Unit | 画像URLから画像を取得できない場合、エラーメッセージが返されることを確認 | - `/api/generate`エンドポイントが実装されている<br>- 無効な画像URLが提供される | 1. POSTリクエストを`/api/generate`に送信（無効な画像URL）<br>2. エラーメッセージが返されることを確認 | FormData: `{ imageUrl: 'https://example.com/invalid.jpg', ... }` | - `fetch(imageUrl)`が失敗する<br>- エラーメッセージ「画像の取得に失敗しました。再試行してください。」が返される<br>- 400ステータスが返される | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 3 | P1 |
| UT-018 | 許可されていないホストのimageUrlでエラーを返す（異常系） | Unit | Vercel Blob以外のURLを拒否できることを確認（SSRF対策） | - `/api/generate`エンドポイントが実装されている<br>- ホストallowlist検証が実装されている | 1. POSTリクエストを`/api/generate`に送信（Vercel Blob以外のURL）<br>2. エラーメッセージが返されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', ... }` | - allowlist検証に失敗する<br>- エラーメッセージが返される<br>- 400ステータスが返される | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 3 | P1 |
| UT-019 | 生成結果をVercel Blobに保存できる（正常系） | Unit | `put()`を使用して生成結果をVercel Blobに保存できることを確認 | - `/api/generate`エンドポイントが実装されている<br>- Gemini APIからbase64レスポンスが返される<br>- `@vercel/blob`がインストールされている | 1. POSTリクエストを`/api/generate`に送信<br>2. Gemini APIからbase64レスポンスが返される<br>3. `put()`が呼び出されることを確認<br>4. URLが取得されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', ... }`<br>Geminiレスポンス: `{ candidates: [{ content: { parts: [{ inlineData: { data: 'base64...', mimeType: 'image/png' } }] } }] }` | - `Buffer.from(outBase64, 'base64')`でBufferに変換される<br>- `put()`が呼び出される<br>- `blob.url`が取得される<br>- エラーが発生しない | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 1 | P1 |
| UT-020 | 生成成功時に元画像を削除する（正常系） | Unit | 生成成功時に`del()`を使用して元画像を削除できることを確認 | - `/api/generate`エンドポイントが実装されている<br>- 生成が成功している<br>- 元画像のURLが保存されている | 1. POSTリクエストを`/api/generate`に送信<br>2. 生成が成功する<br>3. `del(uploadedImageUrl)`が呼び出されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', ... }` | - `del(uploadedImageUrl)`が呼び出される<br>- 元画像が削除される<br>- ログが記録される | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 1 | P2 |
| UT-021 | 生成失敗時に元画像を保持する（正常系） | Unit | 生成失敗時に元画像を削除せず、保持することを確認 | - `/api/generate`エンドポイントが実装されている<br>- 生成が失敗している | 1. POSTリクエストを`/api/generate`に送信<br>2. 生成が失敗する<br>3. `del()`が呼び出されないことを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', ... }` | - `del()`が呼び出されない<br>- 元画像が保持される<br>- エラーメッセージが返される | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 3 | P1 |
| UT-022 | 削除失敗時にログを記録するが処理は続行する（異常系） | Unit | 元画像削除が失敗した場合、ログを記録するが処理は続行することを確認 | - `/api/generate`エンドポイントが実装されている<br>- 生成が成功している<br>- `del()`が失敗する | 1. POSTリクエストを`/api/generate`に送信<br>2. 生成が成功する<br>3. `del()`が失敗する<br>4. ログが記録されることを確認<br>5. 処理が続行されることを確認 | FormData: `{ imageUrl: 'https://example.com/image.jpg', ... }` | - `del()`が失敗する<br>- 警告ログが記録される<br>- 処理が続行される<br>- 200ステータスが返される | `app/api/generate/route.ts`<br>`POST()` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 3 | P2 |

### saveOnDesktop.ts

| テストID | テスト名 | テスト種別 | テスト観点・目的 | 前提条件 | 実行手順 | テストデータ | 期待結果 | 対象ファイル/関数 | 予想カバレッジ率 | 関連ユーザーストーリー | 優先度 |
|---------|---------|-----------|----------------|---------|---------|------------|---------|------------------|----------------|---------------------|--------|
| UT-023 | URLから画像を取得してダウンロードできる（正常系） | Unit | `fetch(imageUrl)`で画像を取得し、ダウンロードできることを確認 | - `saveOnDesktop`関数が実装されている<br>- 有効な画像URLが提供される | 1. `saveOnDesktop(imageUrl, mimeType)`を呼び出す<br>2. `fetch(imageUrl)`が呼び出されることを確認<br>3. ダウンロードが実行されることを確認 | `imageUrl: 'https://example.com/image.jpg'`<br>`mimeType: 'image/jpeg'` | - `fetch(imageUrl)`が呼び出される<br>- 画像が取得される<br>- `URL.createObjectURL()`が呼び出される<br>- ダウンロードリンクがクリックされる<br>- `URL.revokeObjectURL()`が呼び出される | `app/lib/save/saveOnDesktop.ts`<br>`saveOnDesktop()` | 行カバレッジ: 90%<br>分岐カバレッジ: 85% | User Story 2 | P1 |
| UT-024 | 画像取得失敗時にエラーをスローする（異常系） | Unit | 画像URLから画像を取得できない場合、エラーをスローすることを確認 | - `saveOnDesktop`関数が実装されている<br>- 無効な画像URLが提供される | 1. `saveOnDesktop(invalidUrl, mimeType)`を呼び出す<br>2. エラーがスローされることを確認 | `imageUrl: 'https://example.com/invalid.jpg'`<br>`mimeType: 'image/jpeg'` | - `fetch(imageUrl)`が失敗する<br>- エラーがスローされる<br>- エラーメッセージがコンソールに出力される | `app/lib/save/saveOnDesktop.ts`<br>`saveOnDesktop()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 3 | P1 |

### saveOnMobile.ts

| テストID | テスト名 | テスト種別 | テスト観点・目的 | 前提条件 | 実行手順 | テストデータ | 期待結果 | 対象ファイル/関数 | 予想カバレッジ率 | 関連ユーザーストーリー | 優先度 |
|---------|---------|-----------|----------------|---------|---------|------------|---------|------------------|----------------|---------------------|--------|
| UT-025 | URLから画像を取得してWeb Share APIで保存できる（正常系） | Unit | `fetch(imageUrl)`で画像を取得し、Web Share APIで保存できることを確認 | - `saveOnMobile`関数が実装されている<br>- 有効な画像URLが提供される<br>- `navigator.share`が利用可能 | 1. `saveOnMobile(imageUrl)`を呼び出す<br>2. `fetch(imageUrl)`が呼び出されることを確認<br>3. `navigator.share()`が呼び出されることを確認 | `imageUrl: 'https://example.com/image.jpg'` | - `fetch(imageUrl)`が呼び出される<br>- 画像が取得される<br>- `navigator.share()`が呼び出される<br>- `{ outcome: 'camera-roll-saved' }`が返される | `app/lib/save/saveOnMobile.ts`<br>`saveOnMobile()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 2 | P1 |
| UT-026 | Web Share API非対応時にフォールバックダウンロードを実行する（正常系） | Unit | Web Share APIが利用できない場合、フォールバックダウンロードを実行することを確認 | - `saveOnMobile`関数が実装されている<br>- 有効な画像URLが提供される<br>- `navigator.share`が利用不可 | 1. `saveOnMobile(imageUrl)`を呼び出す<br>2. `navigator.share`が利用できないことを確認<br>3. フォールバックダウンロードが実行されることを確認 | `imageUrl: 'https://example.com/image.jpg'` | - `navigator.share`が利用できないことを確認<br>- フォールバックダウンロードが実行される<br>- `{ outcome: 'fallback-downloaded', message: '...' }`が返される | `app/lib/save/saveOnMobile.ts`<br>`saveOnMobile()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 2 | P1 |
| UT-027 | 画像取得失敗時にエラーを返す（異常系） | Unit | 画像URLから画像を取得できない場合、エラーを返すことを確認 | - `saveOnMobile`関数が実装されている<br>- 無効な画像URLが提供される | 1. `saveOnMobile(invalidUrl)`を呼び出す<br>2. エラーが返されることを確認 | `imageUrl: 'https://example.com/invalid.jpg'` | - `fetch(imageUrl)`が失敗する<br>- `{ outcome: 'failed', message: '...' }`が返される | `app/lib/save/saveOnMobile.ts`<br>`saveOnMobile()` | 行カバレッジ: 85%<br>分岐カバレッジ: 80% | User Story 3 | P1 |

### 単体テストセクション全体の予想カバレッジ率

- **行カバレッジ**: 85%以上
- **分岐カバレッジ**: 80%以上

## 統合テスト（Integration Tests）

| テストID | テスト名 | テスト種別 | テスト観点・目的 | 前提条件 | 実行手順 | テストデータ | 期待結果 | 対象ファイル/関数 | 予想カバレッジ率 | 関連ユーザーストーリー | 優先度 |
|---------|---------|-----------|----------------|---------|---------|------------|---------|------------------|----------------|---------------------|--------|
| IT-001 | エンドツーエンドのアップロード→生成→表示フロー（正常系） | Integration | ファイル選択から生成結果表示までの一連のフローが正常に動作することを確認 | - アプリケーションが起動している<br>- Vercel Blobが設定されている<br>- Gemini APIが利用可能 | 1. ファイル入力で有効な画像ファイルを選択<br>2. アップロードが完了し、URLが取得されることを確認<br>3. 生成処理を実行<br>4. 生成結果のURLが取得されることを確認<br>5. 画像が表示されることを確認 | ファイル: `test-image.jpg` (2MB, `image/jpeg`)<br>選択: `textPhraseId: 'phrase1'`, `styleIds: ['style1']`, `positionId: 'pos1'` | - アップロードが完了する<br>- 生成処理が成功する<br>- 生成結果のURLが取得される<br>- 画像が表示される<br>- エラーが発生しない | `app/components/KuuGenerator/UploadSection.tsx`<br>`app/components/KuuGenerator/actions.ts`<br>`app/api/generate/route.ts`<br>`app/components/KuuGenerator/KuuGenerator.tsx` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 1, User Story 2 | P1 |
| IT-002 | アップロード→生成→ダウンロードフロー（正常系） | Integration | ファイル選択から生成結果ダウンロードまでの一連のフローが正常に動作することを確認 | - アプリケーションが起動している<br>- Vercel Blobが設定されている<br>- Gemini APIが利用可能 | 1. ファイル入力で有効な画像ファイルを選択<br>2. アップロードが完了する<br>3. 生成処理を実行<br>4. 生成結果が表示される<br>5. ダウンロードボタンをクリック<br>6. 画像がダウンロードされることを確認 | ファイル: `test-image.jpg` (2MB, `image/jpeg`)<br>選択: `textPhraseId: 'phrase1'`, `styleIds: ['style1']`, `positionId: 'pos1'` | - アップロードが完了する<br>- 生成処理が成功する<br>- ダウンロードボタンが表示される<br>- ダウンロードが実行される<br>- 画像ファイルがダウンロードされる | `app/components/KuuGenerator/UploadSection.tsx`<br>`app/components/KuuGenerator/actions.ts`<br>`app/api/generate/route.ts`<br>`app/components/KuuGenerator/SaveActions.tsx`<br>`app/lib/save/saveOnDesktop.ts` | 行カバレッジ: 80%<br>分岐カバレッジ: 75% | User Story 1, User Story 2 | P1 |
| IT-003 | アップロード中断→再アップロードフロー（正常系） | Integration | アップロード中断後に再アップロードできることを確認 | - アプリケーションが起動している<br>- Vercel Blobが設定されている | 1. ファイル入力で有効な画像ファイルを選択<br>2. アップロード中に中断操作を実行<br>3. 別のファイルを選択して再アップロード<br>4. アップロードが完了することを確認 | ファイル1: `test-image1.jpg` (5MB, `image/jpeg`)<br>ファイル2: `test-image2.jpg` (2MB, `image/jpeg`) | - アップロードが中断される<br>- エラーメッセージが表示される<br>- 再アップロードが実行される<br>- アップロードが完了する | `app/components/KuuGenerator/UploadSection.tsx` | 行カバレッジ: 75%<br>分岐カバレッジ: 70% | User Story 3 | P2 |
| IT-004 | 生成失敗→再試行フロー（正常系） | Integration | 生成失敗後に再試行できることを確認 | - アプリケーションが起動している<br>- Vercel Blobが設定されている<br>- Gemini APIが一時的に利用不可 | 1. ファイル入力で有効な画像ファイルを選択<br>2. アップロードが完了する<br>3. 生成処理を実行（Gemini APIが失敗）<br>4. エラーメッセージが表示されることを確認<br>5. 再試行を実行<br>6. 生成処理が成功することを確認 | ファイル: `test-image.jpg` (2MB, `image/jpeg`)<br>選択: `textPhraseId: 'phrase1'`, `styleIds: ['style1']`, `positionId: 'pos1'` | - 生成処理が失敗する<br>- エラーメッセージが表示される<br>- 元画像が保持される<br>- 再試行が実行される<br>- 生成処理が成功する | `app/components/KuuGenerator/actions.ts`<br>`app/api/generate/route.ts` | 行カバレッジ: 75%<br>分岐カバレッジ: 70% | User Story 3 | P1 |
| IT-005 | 大容量ファイル（10MB）のアップロード→生成フロー（境界値） | Integration | 10MBのファイルでアップロード→生成フローが正常に動作することを確認 | - アプリケーションが起動している<br>- Vercel Blobが設定されている<br>- Gemini APIが利用可能 | 1. ファイル入力で10MBの画像ファイルを選択<br>2. アップロードが完了することを確認<br>3. 生成処理を実行<br>4. 生成処理が成功することを確認 | ファイル: `large-image.jpg` (10MB, `image/jpeg`)<br>選択: `textPhraseId: 'phrase1'`, `styleIds: ['style1']`, `positionId: 'pos1'` | - アップロードが完了する（10秒以内）<br>- 生成処理が成功する<br>- エラーが発生しない | `app/components/KuuGenerator/UploadSection.tsx`<br>`app/components/KuuGenerator/actions.ts`<br>`app/api/generate/route.ts` | 行カバレッジ: 75%<br>分岐カバレッジ: 70% | User Story 1 | P2 |

### 統合テストセクション全体の予想カバレッジ率

- **行カバレッジ**: 78%以上
- **分岐カバレッジ**: 72%以上

## 全体の予想カバレッジ率

- **行カバレッジ**: 82%以上
- **分岐カバレッジ**: 76%以上
